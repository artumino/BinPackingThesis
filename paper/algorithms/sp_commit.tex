\begin{algorithm}[H] \label{algo:sp_commit}
    \DontPrintSemicolon
    \SetAlgoLined
    \SetKwInOut{Input}{input}
    \SetKwInOut{Output}{output}
    \SetSideCommentRight
    \Input{$s, p, z, z_{min}, \beta_s$}
    \Output{$s$}
    $q_b \gets (q_i \in s.Q: i = p.b)$\;
    \CommentSty{//Filter bad planes}\;
    $q_b.Z \leftarrow q_b.Z \setminus \{ (z^\prime, I_{support}, I_{upper}) \in q_b.Z : z^\prime < z_{min} \}$\;
    \CommentSty{//Apply insertion}\;
    \ForAll{$i \in p.I$}{
        $q_b.T \leftarrow InsertAABB(i, q_b.T)$ \CommentSty{//If balanced $O(log(n))$}\; %TODO: specify balanced
        $generate \leftarrow true$\;
        % O(|P'|)
        \ForAll{$(z^\prime, I_{support}, I_{upper}) \in q_b.Z$}{ %TODO: specify balanced
            \CommentSty{//Based on the distance from the top of the item}\;
            $dz \leftarrow z^\prime - (z_i + h_i)$\;
            \If{$0 \le dz \le \beta_s$}{
                $generate \leftarrow false$\;
                $I_{support} \leftarrow I_{support} \cup i$\;
            } \ElseIf{$dz < 0$}{
                $I_{upper} \leftarrow I_{upper} \cup i$\;
            }
        }

        \If{$generate$}{
            $q_b.Z \leftarrow q_b.Z \cup (z_i + h_i, \{i\}, \emptyset)$\;
        }
    }
    \Return{$s$}
    \caption{SP Apply and Filter}
\end{algorithm}