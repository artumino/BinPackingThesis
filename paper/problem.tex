\section{3D Bin Packing Problem}

\section{Support} %TODO: Here or in introduction?

\section{MILP Formulation}
\label{sec:milp}%
\subsection*{Conceptual model}
A conceptual model of the problem we are trying to solve would be:

%TODO: Cage Ratio?
\begin{align*}
    \textbf{minimize} \hspace{.5cm}   & \text{unused volume in used bins} \\
    \textbf{subject to} \hspace{.5cm} & \text{all items assigned to one and only one bin} \\
                                      & \text{all items within the bin dimensions} \\
                                      & \text{no overlaps between items in the same bin} \\
                                      & \text{all items with support} \\
\end{align*}

We can now provide the formal definition of the 3DBPP by formulating a mixed integer linear programming problem model.

\subsection*{Formal model}
\label{ssec:formal_model}
We'll now introduce a MILP model for the standard 3DBPP problem definition and then we'll expand it to address the stability constraint afterwards.

We start by defining the known sets and parameters of the problem.
\paragraph*{Sets}
\begin{align*}
    I = \{1,\dots, n \}: \hspace{.5cm}& \text{set of items} \\
    B = \{1,\dots, m \}: \hspace{.5cm}& \text{set of bins} 
\end{align*}
\paragraph*{Parameters}
\begin{align}
          W \times D \times H  \hspace{.5cm}& \text{width $\times$ depth $\times$ height of a bin} \notag \\
                            V  \hspace{.5cm}& \text{bin volume} \notag \\
    w_i \times d_i \times h_i  \hspace{.5cm}& \text{width $\times$ depth $\times$ height of item $i$} & \forall i \in I \label{par:item_dim}
\end{align}

\paragraph*{Variables} We can now introduce the following sets of integer variables
\begin{align}
              (x_i,y_i,z_i) \hspace{.5cm}& \text{bottom front left corner of an item} & \forall i \in I \label{var:item_pos} \\
                    v_{b} \hspace{.5cm}& \begin{cases}
                                            1, \text{if bin $b$ is used} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall b \in B \notag \\
                    u_{ib} \hspace{.5cm}& \begin{cases}
                                            1, \text{if item $i$ is placed in bin $b$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \begin{aligned} \forall i \in I \\ 
                                                                \forall b \in B 
                                                        \end{aligned} \notag \\
                    x^p_{ij} \hspace{.5cm}& \begin{cases}
                                            1, \text{if $x_i + w_i \le x_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
                    y^p_{ij} \hspace{.5cm}& \begin{cases}
                                            1, \text{if $y_i + d_i \le y_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
                    z^p_{ij} \hspace{.5cm}& \begin{cases}
                                            1, \text{if $z_i + h_i \le z_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
            z_b^\text{max} \hspace{.5cm}& \text{maximum height of bin $b$} & \forall b \in B \notag
\end{align}

Given a coordinate system, each item $i$ can be represented univocally in 3D space by \cref{par:item_dim,var:item_pos} as seen in figure \ref{fig:coordinate_system}
\begin{figure}
    \scalebox{0.65}{%
    \input{Images/coordinate_system}
    }
    \caption{Coordinate system representation for a generic item $i$ and it's rotated clone $i \in I^R$ 
    \label{fig:coordinate_system}}
\end{figure}

\paragraph*{Objective function}
\begin{equation}
    \label{eq:objective}
    \min \hspace{.2cm} \sum_{b \in B} (H v_b + z^{max}_b)
\end{equation}

\paragraph*{Constraints}
\begin{eqnarray}
    \sum_{b \in B} u_{ib} = 1 \hspace{.5cm}& & \forall i \in I  \label{cons:all_items_in_bin} \\
    u_{ib} \le v_b \hspace{.5cm}& & \begin{aligned} \forall i \in I \\ 
                                                    \forall b \in B 
                                    \end{aligned} \label{cons:items_in_used_bins} \\
    \begin{aligned} x_i + w_i &\le W \\ 
                    y_i + d_i &\le D \\
                    z_i + h_i &\le H \\ \end{aligned} \hspace{.5cm}& & \forall i \in I \label{cons:inside} \\
    z^{max}_b \ge (z_i + h_i) - H(1-u_{ib}) \hspace{.5cm}& & \begin{aligned} \forall i \in I \\ 
                                                                    \forall b \in B 
                                                            \end{aligned} \label{cons:maxz} \\
    \begin{aligned} (x_i + w_i) - x_j &< W(1 - x^p_{ij}) \\ %FIXME: should all be labeled, check the inequalities they are probably wrong
                    x_j - (x_i + w_i) &\le W x^p_{ij} \end{aligned} \hspace{.5cm}& & \forall i,j \in I \label{cons:x_prec} \\
    \begin{aligned} (y_i + d_i) - y_j &< D(1 - y^p_{ij}) \\
                    y_j - (y_i + d_i) &\le D y^p_{ij} \end{aligned} \hspace{.5cm}& & \forall i,j \in I \label{cons:y_prec} \\
    \begin{aligned} (z_i + h_i) - z_j &< H(1 - z^p_{ij}) \\
                    z_j - (z_i + h_i) &\le H z^p_{ij} \end{aligned} \hspace{.5cm}& & \forall i,j \in I \label{cons:z_prec} \\
    x^p_{ij} + x^p_{ji} + y^p_{ij} + y^p_{ji} + z^p_{ij} + z^p_{ji} \le 7 - (u_{ib} + u_{jb}) \hspace{.5cm}& & \begin{aligned} \forall i,j \in I \\ 
                                                                                                                                \forall b \in B 
                                                                                                                        \end{aligned} \label{cons:no_overlap}
\end{eqnarray}
\subsection*{Othogonal rotations}

Let us extend the definition of the bin packing problem without rotations with a new formulation which allows $90$ degrees rotations of each item.
Let $I = I^O \cup I^R$ be the new set of items where $I^O$ is the set of original non-rotated items and $I^R$ is the set of items rotated by $90$ degrees.

We can now rewrite constraint \ref{cons:all_items_in_bin} as \ref{cons:all_items_in_bin_with_rotation} to force only one for the item between the original and rotated to be part of the solution.

\begin{align}
    %TODO: Non va bene
    \sum_{b \in B} u_{ib} + \sum_{b \in B} u_{jb} = 1  \hspace{.5cm}& & \forall j = i^R \in I \label{cons:all_items_in_bin_with_rotation}
\end{align}

\subsection*{Static stability constraints}

We now extend the model introduced in \cref{ssec:formal_model} to add constraints addressing static stability.

\paragraph*{Additional Parameters}
\begin{align*}
    \alpha_s  :\hspace{.5cm}& \text{support area threshold} \\
    \beta_s  :\hspace{.5cm}& \text{support height tolerance} \\
    DU      :\hspace{.5cm}& \text{discretization unity} \\
\end{align*}

\paragraph*{Additional Variables}


\paragraph*{Computed Parameters}
\begin{align}
    \gamma = \max_{\forall i \in I}\{ w_i, d_i \}  :\hspace{.5cm}& \text{maximum possible dimension of an item} \notag \\
    XY_{rel} =  [ - \frac{\lfloor \gamma \rfloor}{DU}, \frac{\lfloor \gamma \rfloor}{DU}]  :\hspace{.5cm}& \text{set of possible distances between overlapping items} \notag \\
    O : I \times B \times I \times B \times XY_{rel} \times XY_{rel} \rightarrow \mathbb{R}^+ :\hspace{.5cm}& \text{discrete overlap function} \label{eq:overlap_function}
\end{align}