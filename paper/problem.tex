In this thesis we address the 3D single bin-size bin packing problem (3D-SBSBPP). Starting from a set of items of different size the goal is to arrange them in the least ammount of bins of a given fixed size without any overlap between eachother.
In addition to the standard formulation of the problem three additional practical constraints needs to be taken into account to satisfy the requests of our use-case:
\begin{itemize}
    \item each item inside a bin should have static stability, meaning that every item should be supported either by the ground or by other items in the same bin
    \item the cage ratio of each used bin should be maximized
    \item each item can be rotated orthogonally along its vertical axis
\end{itemize}

Given a certain placement of items inside a bin of base $W \times D$ with the top of the highest item being at $z_\text{max}$ and the sum of the volume of each item being $V$, the bin's cage ratio is defined as $\text{CR} = \frac{V}{W \cdot D \cdot z_\text{max}}$.
As seen in \cref{fig:cage_ratio}, a high cage ratio means that even if a bin isn't fully occupied it could potentially be used as a base for other items. In a single bin setting maximizing cage ratio is equivalent to minimizing $z_\text{max}$.

\begin{figure}[H]
    \scalebox{0.60}{%
    \input{Images/cage_ratio}
    }
    \caption{Cage ratio of two different bin configurations}
    \label{fig:cage_ratio}
\end{figure}

Our notion of vertical support stems from rules imposed by the industry and from the literature on Pallet Loading Problems where stability is usually ensured between layers of items as a constraint on the minimum ammount of area which rests on other items \cite{elhedhli2019three}.
As seen in \cref{fig:support}, given a support area threshold which is usually equal to $\beta_s=0.7$ and a tollerance which in our case is equal to $\alpha_s=1\text{cm}$, we can define an item as supported if
\begin{enumerate}
    \item the sum of overlap area with every other item on which it is resting is greater then $\beta_s$ times it's area
    \item the number of its corners resting on another item is greater than 3 and condition 1 holds with a lower threshold $\beta^\prime_s < \beta$
\end{enumerate}

\begin{figure}[H]
    \scalebox{0.55}{%
    \input{Images/support}
    }
    \caption{Rappresentation of an item with vertical support given $\beta_s = 0.5, \alpha_s$}
    \label{fig:support}
\end{figure}

\newpage
Given the definitions of our practical constraints, a conceptual formulation of our model would be
\begin{eqnarray*}
    \textbf{minimize} & \text{number of used bins} \\
                        & \text{unused volume of each bin under $z_\text{max}$} \\
    \textbf{subject to} & \text{all items assigned to one and only one bin} \\
                                      & \text{all items within the bin dimensions} \\
                                      & \text{no overlaps between items in the same bin} \\
                                      & \text{all items with vertical support} \\
\end{eqnarray*}

We'll now introduce a mixed integer linear programming model for the 3D-SBSBPP that we then extend to include orthogonal rotations and vertical support constraints limited to condition of area support.
Cage ratio isn't directly included in the proposed MILP formulation since the evaluation of the heuristic with the model was done in a single bin configuration where minimizing the maximum height of the bin is equivalent to minimizing the cage ratio.

\section{3D single bin-size bin packing problem}
\label{sec:milp}%
Let $I = \{1,\dots, n \}$ be the set of items that needs to be packed, $B = \{1,\dots, m \}$ the set of bins to evaluate of fixed dimensions $W \times D \times H$.
Each item $i \in I$ is characterized by a given width, depth  and height $(w_i, d_i, h_i)$. 
Let us introduce three continuous variables that identify the position of the bottom front left corner of an item $(x_i, y_i, h_i)$ as seen in \cref{fig:coordinate_system}.
We can now introduce a set of integer variables $v_{b}$ which will be 1 if bin $b \in B$ will be used in the solution and 0 otherwhise. A set of integer variable $u_{ib}$ which will be 1 if item $i \in I$ will be placed in bin $b \in B$ and 0 otherwhise.
In order to check for overlaps three sets of integer variables are introduced for each axis of possible overlap that are used to determine if there is a clear order of precedence on at least on axis. This formulation is also usually used in scheduling problems.
The three sets of variables are $x^p_{ij}$ which will take the value of one if item $i \in I$ precedes item $j \in I$ over axis $x$ given that item $i$ precedes item $j$ if $x_i + w_i \le x_j$ and 0 otherwhise. 
The other two sets are defined in a similar way over the remaining axis $y^p_{ij}$ and $z^p_{ij}$. An additional set of continuous variables $z_b^\text{max}$ is introduced which will assume the value of the maximum $x_i + h_i$ of the items $i \in I$ placed in bin $b \in B$.

\begin{figure}
    \scalebox{0.62}{%
    \input{Images/coordinate_system}
    }
    \caption{Coordinate system representation for a generic item $i$ and it's rotated clone $i \in I^R$}
    \label{fig:coordinate_system}
\end{figure}

The 3D-SBSBPP can then be formulated as a mixed-integer linear programming problem:
\label{par:standard_const}
\begin{align}
   \min       \qquad& \sum\limits_{b \in B} (H v_b + z^{max}_b) & \label{eq:objective} \\
   \text{s.t.} \qquad& \sum\limits_{b \in B}{u_{ib}} = 1 & \forall i \in I  \label{cons:all_items_in_bin} \\
                    & u_{ib} \le v_b & \forall i \in I, \forall b \in B \label{cons:items_in_used_bins} \\
                    & v_b \ge v_c & \forall (b,c) \in B : b < c  \label{cons:bin_breaking} \\
                    & x_i + w_i \le W & \forall i \in I \label{cons:inside_x} \\ 
                    & y_i + d_i \le D & \forall i \in I \label{cons:inside_y} \\ 
                    & z_i + h_i \le H & \forall i \in I \label{cons:inside_z} \\ 
                    & z^{max}_b \ge (z_i + h_i) - H(1-u_{ib}) & \forall i \in I, \forall b \in B \label{cons:maxz} \\
                    & (x_i + w_i) - x_j\le W(1 - x^p_{ij}) & \forall i,j \in I \label{cons:x_prec_1} \\
                    & x_j - (x_i + w_i) + 1 \le W x^p_{ij} & \forall i,j \in I \label{cons:x_prec_2} \\
                    & (y_i + d_i) - y_j \le D(1 - y^p_{ij}) & \forall i,j \in I \label{cons:y_prec_1} \\
                    & y_j - (y_i + d_i) + 1 \le D y^p_{ij} & \forall i,j \in I \label{cons:y_prec_2} \\
                    & (z_i + h_i) - z_j\le H(1 - z^p_{ij}) & \forall i,j \in I \label{cons:z_prec_1} \\
                    & z_j - (z_i + h_i) + 1 \le H z^p_{ij} & \forall i,j \in I \label{cons:z_prec_2} \\
                    & x^p_{ij} + x^p_{ji} + y^p_{ij} + y^p_{ji} + z^p_{ij} + z^p_{ji} \ge u_{ib} + u_{jb} - 1 & \forall i,j \in I, \forall b \in B \label{cons:no_overlap}
\end{align}

The objective function \ref{eq:objective} seeks to minimize the number of opened bins and the maximum heights of the opened bins. In a single bin configuration since all the volume mass is concentrated inside one bin this also means that it maximises the cage ratio.
Constraint \ref{cons:all_items_in_bin} ensures that each item is packed in one and only one bin, while contraint \ref{cons:items_in_used_bins} ensures that items are only packed in bins that are used in the solution.
Since the solution as lots of simmetries with respects to the number of bins a simmetry breaking constraint \ref{cons:bin_breaking} can be added on the opening of bins to improve solve times.
Each item is also ensured to be placed inside the bin thanks to \cref{cons:inside_x,cons:inside_y,cons:inside_z}.
The value of $z^{max}_b$ is forced to converge to the maximum height of a given bin thanks to constraint \ref{cons:maxz}.
Constraints from \ref{cons:x_prec_1} to \ref{cons:z_prec_2} are used to define the precedence binary variables $x^p_{ij}$, $y^p_{ij}$, $z^p_{ij}$ over each axis as described in the problem formulation.
Constraint \ref{cons:no_overlap} then ensures that if two items are in the same bin then there needs to be at least one axis with a clear order of precedence, otherwise the two items would be overlapping eachother.
\subsection*{Othogonal rotations}

Let us extend the definition of the bin packing problem without rotations with a new formulation which allows $90$ degrees rotations of each item.
Let $I = I^O \cup I^R$ be the new set of items where $I^O$ is the set of original non-rotated items and $I^R$ is the set of items rotated by $90$ degrees.

We can now rewrite constraint \ref{cons:all_items_in_bin} as \ref{cons:all_items_in_bin_with_rotation} to force only one for the item between the original and rotated to be part of the solution.

\begin{align}
    %TODO: Non va bene
    & \sum\limits_{b \in B} u_{ib} + \sum\limits_{b \in B} u_{jb} = 1 & \forall j = i^R \in I \label{cons:all_items_in_bin_with_rotation}
\end{align}

\subsection*{Static stability constraints}

We now extend the model introduced in \cref{ssec:formal_model} to add constraints addressing static stability.

\paragraph*{Additional Parameters}
\begin{eqnarray*}
    \alpha_s  &:& \text{support area threshold} \\
    \beta_s  &:& \text{support height tolerance} \\
    \delta      &:& \text{discretization unit} \\
    IB &:& \text{the set of tuples $(i, j, b)$ such that $(i,j) \in I \land i \neq j$ and $b \in B$}
\end{eqnarray*}


\paragraph*{Computed Parameters}
\begin{eqnarray}
    & \gamma = \max_{\forall i \in I}\{ w_i, d_i \}  :& \text{maximum possible dimension of an item} \notag \\
    & \Delta =  \left[ - \left\lfloor \frac{ \gamma }{\delta} \right\rfloor, \left\lfloor \frac{ \gamma }{\delta} \right\rfloor \right]  :& \text{set of possible distances between overlapping items} \notag \\
    & O(i, j, h, k) \rightarrow \mathbb{R}^+ :& \text{discrete overlap function} \label{eq:overlap_function}
\end{eqnarray}

\paragraph*{Additional Variables}
\begin{align*}
        s_{ij} & \begin{cases}
                        1, \text{if item $i$ can offer support to item $j$} \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        z^c_{ij} & \begin{cases}
                        1, \text{if $ 0 \le z_j - (z_i + h_i) \le \beta_s$ } \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        g_i & \begin{cases}
                        1, \text{if $z_i = 0$ } \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        s^{kh}_{i j b} & \begin{cases}
                    1, \text{if item $i$ receives support from item $j$} \\ \qquad \text{when both are placed in bin $b$} \\ \qquad \text{with distance $(k, h) \in \Delta$ between eachother } \\ 
                    0, \text{otherwise}
                \end{cases} & \forall (i,j) \in I
\end{align*}

\paragraph*{Additional Constraints}
\label{par:support_const}
\begin{align}
    & z_j - (z_i + h_i) \le \beta_s + H (1 - z^c_{ij}) & \forall (i, j) \in I : i \neq j \label{cons:z_close_1} \\
    & z_j - (z_i + h_i) \ge -\beta_s - H (1 - z^c_{ij}) & \forall (i, j) \in I : i \neq j \label{cons:z_close_2} \\
    & s_{ij} \le z^p_{ij} & \forall (i, j) \in I  \label{cons:supporting_1} \\
    & s_{ij} \le z^c_{ij} & \forall (i, j) \in I  \label{cons:supporting_2} \\
    & s_{ij} \ge z^p_{ij} + z^c_{ij} - 2 & \forall (i, j) \in I : i \neq j \label{cons:supporting} \\
    & \sum\limits_{j \in I}{s_{ij}} \le \sum\limits_{b \in B}{u_{ib}} & \forall i \in I  \label{cons:support_comes_from_placed} \\
    & z_i \le H(1 - g_i) & \forall i \in I \label{cons:grounded} \\
    & \sum\limits_{(k, h) \in \Delta, b \in B : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le s_{ij} & \forall (i, j) \in I \label{cons:discretized_support_same} \\
    & \sum\limits_{(k, h) \in \Delta : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le u_{ib} & \forall (i, j, b) \in IB \label{cons:discretized_support_right_bin_i} \\
    & \sum\limits_{(k, h) \in \Delta : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le u_{jb} & \forall (i, j, b) \in IB \label{cons:discretized_support_right_bin_j} \\
\end{align}

We can then define a set of constraints which given a discretized placement $s^{k h}_{i j b}$ limits the distance between $i$ and $j$ to a given continuous region in space delimited by a square of the dimmension of our discretization unit $\gamma$. 
Given every $ (k, h) \in \Delta, (i, j, b) \in IB$ such that $O(i, j, k, h) \neq 0$ the resulting constraints are defined in \cref{cons:discretized_support_limit_x_1,cons:discretized_support_limit_x_2,cons:discretized_support_limit_y_1,cons:discretized_support_limit_y_2}.
\begin{align}
    & x_j - x_i \ge \gamma k - 2W( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_x_1} \\
    & x_j - x_i \le \gamma (k + 1) + 2W( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_x_2} \\
    & y_j - y_i \ge \gamma h - 2D( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_y_1} \\
    & y_j - y_i \le \gamma (h + 1) + 2D( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_y_2}
\end{align}

And finally we can introduce a feasibility constraint which ensures that every item that isn't on the ground is supported by some items in the same bin.
\begin{eqnarray}
    & \sum\limits_{(k, h) \in \Delta, b \in B, j \in I : i \neq j \land O(i, j, k, h) \neq 0}{ O(i, j, k, h)s^{k h}_{j i b}} \ge \alpha_s w_i d_i - w_i d_i g_i & \forall i \in I \label{cons:every_item_is_supported}
\end{eqnarray}