\section{3D Bin Packing Problem}

\subsection*{Vertical Support} %TODO: Here or in introduction?

In addition to the non overlapping requirements of the 3D-BPP other practical constraints are usually introduced to address various problems. 


\section{MILP Formulation}
\label{sec:milp}%
\subsection*{Conceptual model}
A conceptual model of the problem we are trying to solve would be:

%TODO: Cage Ratio?
\begin{eqnarray*}
    \textbf{minimize} & \text{unused volume in used bins} \\
    \textbf{subject to} & \text{all items assigned to one and only one bin} \\
                                      & \text{all items within the bin dimensions} \\
                                      & \text{no overlaps between items in the same bin} \\
                                      & \text{all items with support} \\
\end{eqnarray*}

We can now provide the formal definition of the 3DBPP by formulating a mixed integer linear programming problem model.

\subsection*{Formal model}
\label{ssec:formal_model}
We'll now introduce a MILP model for the standard 3DBPP problem definition and then we'll expand it to address the stability constraint afterwards.

We start by defining the known sets and parameters of the problem.
\paragraph*{Sets}
\begin{eqnarray*}
    I = \{1,\dots, n \}: & \text{set of items} \\
    B = \{1,\dots, m \}: & \text{set of bins} 
\end{eqnarray*}
\paragraph*{Parameters}
\begin{eqnarray}
          W \times D \times H  & \text{width $\times$ depth $\times$ height of a bin} \notag \\
                            V  & \text{bin volume} \notag \\
    w_i \times d_i \times h_i  & \text{width $\times$ depth $\times$ height of item $i$} & \forall i \in I \label{par:item_dim}
\end{eqnarray}

\paragraph*{Variables} We can now introduce the following sets of integer variables
\begin{align}
              (x_i,y_i,z_i) & \qquad \text{bottom front left corner of an item} & \forall i \in I \label{var:item_pos} \\
                    v_{b} & \begin{cases}
                                            1, \text{if bin $b$ is used} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall b \in B \notag \\
                    u_{ib} & \begin{cases}
                                            1, \text{if item $i$ is placed in bin $b$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i \in I, \forall b \in B  \notag \\
                    x^p_{ij} & \begin{cases}
                                            1, \text{if $x_i + w_i \le x_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
                    y^p_{ij} & \begin{cases}
                                            1, \text{if $y_i + d_i \le y_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
                    z^p_{ij} & \begin{cases}
                                            1, \text{if $z_i + h_i \le z_j$} \\ 
                                            0, \text{otherwise}
                                        \end{cases} & \forall i,j \in I \notag \\
            z_b^\text{max} & \text{maximum height of bin $b$} & \forall b \in B \notag
\end{align}

Given a coordinate system, each item $i$ can be represented univocally in 3D space by \cref{par:item_dim,var:item_pos} as seen in figure \ref{fig:coordinate_system}
\begin{figure}
    \scalebox{0.65}{%
    \input{Images/coordinate_system}
    }
    \caption{Coordinate system representation for a generic item $i$ and it's rotated clone $i \in I^R$ 
    \label{fig:coordinate_system}}
\end{figure}

\paragraph*{Objective function}
\begin{equation}
    \label{eq:objective}
    \min \hspace{.2cm} \sum\limits_{b \in B} (H v_b + z^{max}_b)
\end{equation}

\paragraph*{Constraints}
\label{par:standard_const}
\begin{eqnarray}
    & \sum\limits_{b \in B}{u_{ib}} = 1 & \forall i \in I  \label{cons:all_items_in_bin} \\
    & u_{ib} \le v_b & \forall i \in I, \forall b \in B \label{cons:items_in_used_bins} \\
    & v_b \ge v_c & \forall (b,c) \in B : b < c  \label{cons:bin_breaking} \\
    & x_i + w_i \le W & \forall i \in I \label{cons:inside_x} \\ 
    & y_i + d_i \le D & \forall i \in I \label{cons:inside_y} \\ 
    & z_i + h_i \le H & \forall i \in I \label{cons:inside_z} \\ 
    & z^{max}_b \ge (z_i + h_i) - H(1-u_{ib}) & \forall i \in I, \forall b \in B \label{cons:maxz} \\
    & (x_i + w_i) - x_j\le W(1 - x^p_{ij}) & \forall i,j \in I \label{cons:x_prec_1} \\
    & x_j - (x_i + w_i) + 1 \le W x^p_{ij} & \forall i,j \in I \label{cons:x_prec_2} \\
    & (y_i + d_i) - y_j \le D(1 - y^p_{ij}) & \forall i,j \in I \label{cons:y_prec_1} \\
    & y_j - (y_i + d_i) + 1 \le D y^p_{ij} & \forall i,j \in I \label{cons:y_prec_2} \\
    & (z_i + h_i) - z_j\le H(1 - z^p_{ij}) & \forall i,j \in I \label{cons:z_prec_1} \\
    & z_j - (z_i + h_i) + 1 \le H z^p_{ij} & \forall i,j \in I \label{cons:z_prec_2} \\
    & x^p_{ij} + x^p_{ji} + y^p_{ij} + y^p_{ji} + z^p_{ij} + z^p_{ji} \ge u_{ib} + u_{jb} - 1 & \forall i,j \in I, \forall b \in B \label{cons:no_overlap}
\end{eqnarray}
\subsection*{Othogonal rotations}

Let us extend the definition of the bin packing problem without rotations with a new formulation which allows $90$ degrees rotations of each item.
Let $I = I^O \cup I^R$ be the new set of items where $I^O$ is the set of original non-rotated items and $I^R$ is the set of items rotated by $90$ degrees.

We can now rewrite constraint \ref{cons:all_items_in_bin} as \ref{cons:all_items_in_bin_with_rotation} to force only one for the item between the original and rotated to be part of the solution.

\begin{eqnarray}
    %TODO: Non va bene
    & \sum\limits_{b \in B} u_{ib} + \sum\limits_{b \in B} u_{jb} = 1 & \forall j = i^R \in I \label{cons:all_items_in_bin_with_rotation}
\end{eqnarray}

\subsection*{Static stability constraints}

We now extend the model introduced in \cref{ssec:formal_model} to add constraints addressing static stability.

\paragraph*{Additional Parameters}
\begin{eqnarray*}
    \alpha_s  &:& \text{support area threshold} \\
    \beta_s  &:& \text{support height tolerance} \\
    \delta      &:& \text{discretization unit} \\
    IB &:& \text{the set of tuples $(i, j, b)$ such that $(i,j) \in I \land i \neq j$ and $b \in B$}
\end{eqnarray*}


\paragraph*{Computed Parameters}
\begin{eqnarray}
    \gamma = \max_{\forall i \in I}\{ w_i, d_i \}  &:& \text{maximum possible dimension of an item} \notag \\
    \Delta =  \left[ - \left\lfloor \frac{ \gamma }{\delta} \right\rfloor, \left\lfloor \frac{ \gamma }{\delta} \right\rfloor \right]  &:& \text{set of possible distances between overlapping items} \notag \\
    O(i, j, b, h, k) \rightarrow \mathbb{R}^+ &:& \text{discrete overlap function} \label{eq:overlap_function}
\end{eqnarray}

\paragraph*{Additional Variables}
\begin{align*}
        s_{ij} & \begin{cases}
                        1, \text{if item $i$ can offer support to item $j$} \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        z^c_{ij} & \begin{cases}
                        1, \text{if $ 0 \le z_j - (z_i + h_i) \le \beta_s$ } \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        g_i & \begin{cases}
                        1, \text{if $z_i = 0$ } \\ 
                        0, \text{otherwise}
                    \end{cases} & \forall (i,j) \in I \\
        s^{kh}_{i j b} & \begin{cases}
                    1, \text{if item $i$ receives support from item $j$} \\ \qquad \text{when both are placed in bin $b$} \\ \qquad \text{with distance $(k, h) \in \Delta$ between eachother } \\ 
                    0, \text{otherwise}
                \end{cases} & \forall (i,j) \in I
\end{align*}

\paragraph*{Additional Constraints}
\label{par:support_const}
\begin{eqnarray}
    & z_j - (z_i + h_i) \le \beta_s + H (1 - z^c_{ij}) & \forall (i, j) \in I : i \neq j \label{cons:z_close_1} \\
    & z_j - (z_i + h_i) \ge -\beta_s - H (1 - z^c_{ij}) & \forall (i, j) \in I : i \neq j \label{cons:z_close_2} \\
    & s_{ij} \le z^p_{ij} & \forall (i, j) \in I  \label{cons:supporting_1} \\
    & s_{ij} \le z^c_{ij} & \forall (i, j) \in I  \label{cons:supporting_2} \\
    & s_{ij} \ge z^p_{ij} + z^c_{ij} - 2 & \forall (i, j) \in I : i \neq j \label{cons:supporting} \\
    & \sum\limits_{j \in I}{s_{ij}} \le \sum\limits_{b \in B}{u_{ib}} & \forall i \in I  \label{cons:support_comes_from_placed} \\
    & z_i \le H(1 - g_i) & \forall i \in I \label{cons:grounded} \\
    & \sum\limits_{(k, h) \in \Delta, b \in B : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le s_{ij} & \forall (i, j) \in I \label{cons:discretized_support_same} \\
    & \sum\limits_{(k, h) \in \Delta : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le u_{ib} & \forall (i, j, b) \in IB \label{cons:discretized_support_right_bin_i} \\
    & \sum\limits_{(k, h) \in \Delta : O(i, j, k, h) \neq 0} s^{k h}_{i j b} \le u_{jb} & \forall (i, j, b) \in IB \label{cons:discretized_support_right_bin_j} \\
\end{eqnarray}

We can then define a set of constraints which given a discretized placement $s^{k h}_{i j b}$ limits the distance between $i$ and $j$ to a given continuous region in space delimited by a square of the dimmension of our discretization unit $\gamma$. 
Given every $ (k, h) \in \Delta, (i, j, b) \in IB$ such that $O(i, j, k, h) \neq 0$ the resulting constraints are defined in \cref{cons:discretized_support_limit_x_1,cons:discretized_support_limit_x_2,cons:discretized_support_limit_y_1,cons:discretized_support_limit_y_2}.
\begin{align}
    & x_j - x_i \ge \gamma k - 2W( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_x_1} \\
    & x_j - x_i \le \gamma (k + 1) + 2W( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_x_2} \\
    & y_j - y_i \ge \gamma h - 2D( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_y_1} \\
    & y_j - y_i \le \gamma (h + 1) + 2D( 1 - s^{k h}_{i j b}) &  \label{cons:discretized_support_limit_y_2}
\end{align}

And finally we can introduce a feasibility constraint which ensures that every item that isn't on the ground is supported by some items in the same bin.
\begin{eqnarray}
    & \sum\limits_{(k, h) \in \Delta, b \in B, j \in I : i \neq j \land O(i, j, k, h) \neq 0}{ O(i, j, k, h)s^{k h}_{j i b}} \ge \alpha_s w_i d_i - w_i d_i g_i & \forall i \in I \label{cons:every_item_is_supported}
\end{eqnarray}